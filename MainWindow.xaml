<Window x:Class="TaskMate.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:TaskMate.Converters"
        xmlns:local="clr-namespace:TaskMate.ViewModels"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        Title="TaskMate"
        Height="900"
        Width="1000"
        Background="{DynamicResource WindowBackgroundBrush}">
        <Window.Resources>
                <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
                <conv:AssigneeToVisibilityConverter x:Key="AssigneeToVisibilityConverter"/>
                <local:BoolToTextDecorationsConverter x:Key="BoolToTextDecorationsConverter"/>

                <SolidColorBrush x:Key="MeTaskTextBrush"
                                 Color="#4CAF50"/>
                <SolidColorBrush x:Key="PartnerTaskTextBrush"
                                 Color="#E91E63"/>
                <Style x:Key="TaskRowTextStyle"
                       TargetType="TextBlock"
                       BasedOn="{StaticResource {x:Type TextBlock}}">
                        <!-- default (theme) -->
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                        <!-- override by owner -->
                        <Style.Triggers>
                                <DataTrigger Binding="{Binding AssignedTo}"
                                             Value="Me">
                                        <Setter Property="Foreground"
                                                Value="{DynamicResource MeTaskTextBrush}"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding AssignedTo}"
                                             Value="Partner">
                                        <Setter Property="Foreground"
                                                Value="{DynamicResource PartnerTaskTextBrush}"/>
                                </DataTrigger>
                        </Style.Triggers>
                </Style>

                <Style TargetType="{x:Type Control}">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                </Style>
                <Style TargetType="GroupBox">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                </Style>
                <Style TargetType="CheckBox">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                </Style>
                <Style TargetType="Button">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                </Style>
                <Style TargetType="TextBlock">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                </Style>
                <Style TargetType="TextBox"
                       BasedOn="{StaticResource {x:Type TextBox}}">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                        <Setter Property="Background"
                                Value="{DynamicResource ControlBackgroundBrush}"/>
                        <Setter Property="Margin"
                                Value="5"/>
                        <Setter Property="Padding"
                                Value="5"/>
                        <Setter Property="FontSize"
                                Value="14"/>
                        <Setter Property="BorderBrush"
                                Value="{DynamicResource ControlBorderBrush}"/>
                        <Setter Property="BorderThickness"
                                Value="1"/>
                        <Setter Property="Height"
                                Value="28"/>
                </Style>

                <Style TargetType="ComboBox"
                       BasedOn="{StaticResource {x:Type ComboBox}}">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                        <Setter Property="Background"
                                Value="{DynamicResource ControlBackgroundBrush}"/>
                        <Setter Property="BorderBrush"
                                Value="{DynamicResource ControlBorderBrush}"/>
                        <Setter Property="Padding"
                                Value="4"/>
                        <Setter Property="Height"
                                Value="28"/>
                        <Setter Property="Template">
                                <Setter.Value>
                                        <ControlTemplate TargetType="ComboBox">
                                                <Grid>
                                                        <!-- the box you see when it's closed -->
                                                        <Border x:Name="Bd"
                                                                Background="{TemplateBinding Background}"
                                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                                CornerRadius="4"/>

                                                        <!-- content -->
                                                        <ContentPresenter Margin="8,0,28,0"
                                                                          VerticalAlignment="Center"
                                                                          HorizontalAlignment="Left"/>

                                                        <!-- dropdown button -->
                                                        <ToggleButton Grid.Column="1"
                                                                      Focusable="False"
                                                                      IsChecked="{Binding IsDropDownOpen, RelativeSource={RelativeSource TemplatedParent}}"
                                                                      ClickMode="Press"
                                                                      Background="{TemplateBinding Background}"
                                                                      BorderBrush="{TemplateBinding BorderBrush}"
                                                                      BorderThickness="0"
                                                                      HorizontalAlignment="Right"
                                                                      Width="22"
                                                                      Padding="0">
                                                                <Path Data="M 0 0 L 5 5 L 10 0 Z"
                                                                      Width="10"
                                                                      Height="6"
                                                                      Stretch="Uniform"
                                                                      Margin="0,0,0,2"
                                                                      HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"
                                                                      Fill="{DynamicResource PrimaryTextBrush}"/>
                                                        </ToggleButton>

                                                        <!-- popup -->
                                                        <Popup x:Name="Popup"
                                                               Placement="Bottom"
                                                               IsOpen="{TemplateBinding IsDropDownOpen}"
                                                               AllowsTransparency="True"
                                                               Focusable="False"
                                                               PopupAnimation="Slide">
                                                                <Border Background="{DynamicResource ControlBackgroundBrush}"
                                                                        BorderBrush="{DynamicResource ControlBorderBrush}"
                                                                        BorderThickness="1"
                                                                        SnapsToDevicePixels="True"
                                                                        MaxHeight="{TemplateBinding MaxDropDownHeight}"
                                                                        MinWidth="{Binding ActualWidth, RelativeSource={RelativeSource TemplatedParent}}">
                                                                        <!-- key line -->
                                                                        <ScrollViewer>
                                                                                <ItemsPresenter/>
                                                                        </ScrollViewer>
                                                                </Border>
                                                        </Popup>
                                                </Grid>

                                                <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver"
                                                                 Value="True">
                                                                <Setter TargetName="Bd"
                                                                        Property="BorderBrush"
                                                                        Value="{DynamicResource HoverBrush}"/>
                                                        </Trigger>
                                                        <Trigger Property="IsKeyboardFocusWithin"
                                                                 Value="True">
                                                                <Setter TargetName="Bd"
                                                                        Property="BorderBrush"
                                                                        Value="{DynamicResource PressedBrush}"/>
                                                        </Trigger>
                                                        <Trigger Property="IsEnabled"
                                                                 Value="False">
                                                                <Setter Property="Opacity"
                                                                        Value="0.6"/>
                                                        </Trigger>
                                                </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                </Setter.Value>
                        </Setter>
                </Style>
                <Style TargetType="ComboBoxItem">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                        <Setter Property="Background"
                                Value="{DynamicResource ControlBackgroundBrush}"/>
                        <Style.Triggers>
                                <Trigger Property="IsMouseOver"
                                         Value="True">
                                        <Setter Property="Background"
                                                Value="{DynamicResource HoverBrush}"/>
                                </Trigger>
                                <Trigger Property="IsSelected"
                                         Value="True">
                                        <Setter Property="Background"
                                                Value="{DynamicResource PressedBrush}"/>
                                </Trigger>
                        </Style.Triggers>
                </Style>

                <Style TargetType="DatePicker"
                       BasedOn="{StaticResource {x:Type DatePicker}}">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                        <Setter Property="Background"
                                Value="{DynamicResource ControlBackgroundBrush}"/>
                        <Setter Property="BorderBrush"
                                Value="{DynamicResource ControlBorderBrush}"/>
                        <Setter Property="Margin"
                                Value="5"/>
                        <Setter Property="FontSize"
                                Value="14"/>
                        <Setter Property="Height"
                                Value="28"/>
                </Style>
                <!-- DatePicker text box (was white) -->
                <Style TargetType="{x:Type DatePickerTextBox}">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                        <Setter Property="Background"
                                Value="{DynamicResource ControlBackgroundBrush}"/>
                        <Setter Property="BorderBrush"
                                Value="{DynamicResource ControlBorderBrush}"/>
                </Style>
                <!-- Calendar popup (was white) -->
                <Style TargetType="{x:Type Calendar}">
                        <Setter Property="Foreground"
                                Value="{DynamicResource PrimaryTextBrush}"/>
                        <Setter Property="Background"
                                Value="{DynamicResource ControlBackgroundBrush}"/>
                </Style>

                <!-- Generic white card -->
                <Style x:Key="Card"
                       TargetType="Border">
                        <Setter Property="Background"
                                Value="{DynamicResource CardBackgroundBrush}"/>
                        <Setter Property="CornerRadius"
                                Value="10"/>
                        <Setter Property="Padding"
                                Value="12"/>
                        <Setter Property="Margin"
                                Value="0,0,0,10"/>
                        <Setter Property="BorderBrush"
                                Value="{DynamicResource CardBorderBrush}"/>
                        <Setter Property="BorderThickness"
                                Value="1"/>
                        <Setter Property="Effect">
                                <Setter.Value>
                                        <DropShadowEffect BlurRadius="10"
                                                          ShadowDepth="2"
                                                          Opacity="0.15"/>
                                </Setter.Value>
                        </Setter>
                </Style>

                <!-- Card-looking Expander: header = full-width clickable row, content = inside a card -->
                <Style x:Key="CardExpander"
                       TargetType="Expander">
                        <Setter Property="IsExpanded"
                                Value="False"/>
                        <Setter Property="Margin"
                                Value="0,0,0,1"/>
                        <Setter Property="Template">
                                <Setter.Value>
                                        <ControlTemplate TargetType="Expander">
                                                <Border Style="{StaticResource Card}"
                                                        Padding="0">
                                                        <StackPanel>
                                                                <!-- Header row (full row clickable) -->
                                                                <ToggleButton x:Name="HeaderSite"
                                                                              Content="{TemplateBinding Header}"
                                                                              FontWeight="Bold"
                                                                              Focusable="False"
                                                                              HorizontalContentAlignment="Left"
                                                                              IsChecked="{Binding IsExpanded, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                                                              OverridesDefaultStyle="True">
                                                                        <ToggleButton.Template>
                                                                                <ControlTemplate TargetType="ToggleButton">
                                                                                        <!-- no theme chrome = no blue -->
                                                                                        <Border x:Name="HeaderBg"
                                                                                                Background="Transparent"
                                                                                                Padding="12,6"
                                                                                                BorderThickness="0"
                                                                                                CornerRadius="10">

                                                                                                <ContentPresenter VerticalAlignment="Center"/>
                                                                                        </Border>
                                                                                        <!-- optional: subtle hover/pressed you control -->
                                                                                        <ControlTemplate.Triggers>
                                                                                                <Trigger Property="IsMouseOver"
                                                                                                         Value="True">
                                                                                                        <Setter TargetName="HeaderBg"
                                                                                                                Property="Background"
                                                                                                                Value="{DynamicResource HoverBrush}"/>
                                                                                                </Trigger>
                                                                                                <Trigger Property="IsPressed"
                                                                                                         Value="True">
                                                                                                        <Setter TargetName="HeaderBg"
                                                                                                                Property="Background"
                                                                                                                Value="{DynamicResource PressedBrush}"/>
                                                                                                </Trigger>
                                                                                                <Trigger Property="IsChecked"
                                                                                                         Value="True">
                                                                                                        <Setter TargetName="HeaderBg"
                                                                                                                Property="Background"
                                                                                                                Value="Transparent"/>
                                                                                                </Trigger>
                                                                                        </ControlTemplate.Triggers>
                                                                                </ControlTemplate>
                                                                        </ToggleButton.Template>
                                                                </ToggleButton>
                                                                <!-- Expand/collapse content -->
                                                                <ContentPresenter x:Name="ExpandSite"
                                                                                  Visibility="Collapsed"
                                                                                  Margin="12,0,12,12"/>
                                                        </StackPanel>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                        <Trigger SourceName="HeaderSite"
                                                                 Property="IsChecked"
                                                                 Value="True">
                                                                <Setter TargetName="ExpandSite"
                                                                        Property="Visibility"
                                                                        Value="Visible"/>
                                                        </Trigger>
                                                </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                </Setter.Value>
                        </Setter>
                </Style>




                <!-- Inner section card (for each list column) -->
                <Style x:Key="SubCard"
                       TargetType="Border"
                       BasedOn="{StaticResource Card}">
                        <Setter Property="Padding"
                                Value="10"/>
                        <Setter Property="Margin"
                                Value="5"/>
                </Style>

                <!-- Individual task “bubble” -->
                <Style x:Key="TaskItemCard"
                       TargetType="Border">
                        <Setter Property="Background"
                                Value="{DynamicResource TaskItemBackgroundBrush}"/>
                        <Setter Property="CornerRadius"
                                Value="8"/>
                        <Setter Property="Padding"
                                Value="6"/>
                        <Setter Property="Margin"
                                Value="4,3"/>
                        <Setter Property="BorderBrush"
                                Value="{DynamicResource CardBorderBrush}"/>
                        <Setter Property="BorderThickness"
                                Value="1"/>
                        <Setter Property="Effect">
                                <Setter.Value>
                                        <DropShadowEffect BlurRadius="6"
                                                          ShadowDepth="1"
                                                          Opacity="0.12"/>
                                </Setter.Value>
                        </Setter>
                </Style>

                <!-- Section header -->
                <Style x:Key="SectionHeader"
                       TargetType="TextBlock"
                       BasedOn="{StaticResource {x:Type TextBlock}}">
                        <Setter Property="FontSize"
                                Value="16"/>
                        <Setter Property="FontWeight"
                                Value="Bold"/>
                        <Setter Property="Margin"
                                Value="0,0,0,8"/>
                </Style>
        </Window.Resources>

        <Grid Margin="10">
                <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>


                <!-- === TOP SECTIONS: Dashboard, Connections, Task Builder === -->
                <StackPanel Grid.Row="0"
                            Margin="0,0,0,10">

                        <!-- DASHBOARD (no title) -->
                        <Border Style="{StaticResource Card}">
                                <Grid>
                                        <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Greeting (left) -->
                                        <TextBlock
                                                Text="{Binding DisplayName, StringFormat=Welcome Back {0}!}"
                                                FontSize="22"
                                                FontWeight="Bold"
                                                VerticalAlignment="Center">
                                                <TextBlock.Style>
                                                        <Style TargetType="TextBlock"
                                                               BasedOn="{StaticResource {x:Type TextBlock}}">
                                                                <Setter Property="Visibility"
                                                                        Value="Visible"/>
                                                                <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding NeedsProfileSetup}"
                                                                                     Value="True">
                                                                                <Setter Property="Visibility"
                                                                                        Value="Collapsed"/>
                                                                        </DataTrigger>
                                                                </Style.Triggers>
                                                        </Style>
                                                </TextBlock.Style>
                                        </TextBlock>

                                        <!-- Date/Time + 3 buttons (right) -->
                                        <StackPanel Grid.Column="1"
                                                    Orientation="Horizontal"
                                                    VerticalAlignment="Center">
                                                <TextBlock
                                                        Text="{Binding Now, StringFormat={}{0:dddd, MMM d • h:mm tt}}"
                                                        Margin="0,0,8,0"
                                                        VerticalAlignment="Center"
                                                        Opacity="0.8"/>
                                                <Button Content="{Binding ThemeButtonText}"
                                                        MinWidth="110"
                                                        Command="{Binding ToggleThemeCommand}"/>
                                                <Button Content="button"
                                                        MinWidth="90"/>
                                                <Button Content="Refresh"
                                                        MinWidth="85"/>
                                        </StackPanel>
                                </Grid>
                        </Border>

                        <!-- CONNECTIONS -->
                        <Expander Style="{StaticResource CardExpander}">
                                <Expander.Header>
                                        <Grid>
                                                <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="Connections"
                                                           Style="{StaticResource SectionHeader}"
                                                           Margin="0"/>
                                                <!-- optional chevron or hint on the right -->
                                                <TextBlock Grid.Column="1"
                                                           Text="▼"
                                                           Opacity="0.6"
                                                           Margin="8,0,0,0"/>
                                        </Grid>
                                </Expander.Header>

                                <!-- Content shown when expanded (your existing Connections content WITHOUT the title) -->
                                <StackPanel>
                                        <!-- Codes Row (aligned halves) -->
                                        <Grid Margin="0,0,0,8"
                                              Grid.IsSharedSizeScope="True">
                                                <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- LEFT: Your Code -->
                                                <Grid Grid.Column="0">
                                                        <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="130"
                                                                                  SharedSizeGroup="ConnLabels"/>
                                                                <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        <TextBlock Grid.Column="0"
                                                                   Text="Your Code:"
                                                                   VerticalAlignment="Center"/>
                                                        <TextBox Grid.Column="1"
                                                                 Text="{Binding UserId, Mode=OneWay}"
                                                                 IsReadOnly="True"
                                                                 BorderThickness="0"
                                                                 Background="{x:Null}"
                                                                 Padding="0"
                                                                 FontWeight="Bold"
                                                                 VerticalAlignment="Center"/>
                                                </Grid>

                                                <!-- RIGHT: Connection area (three states) -->
                                                <Grid Grid.Column="1">
                                                        <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                        </Grid.RowDefinitions>

                                                        <!-- STATE A: Enter partner code -->
                                                        <Grid x:Name="EnterCodeRow">
                                                                <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="130"
                                                                                          SharedSizeGroup="ConnLabels"/>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>

                                                                <!-- show when NOT connected AND NO pending outgoing -->
                                                                <Grid.Style>
                                                                        <Style TargetType="Grid">
                                                                                <Setter Property="Visibility"
                                                                                        Value="Collapsed"/>
                                                                                <Style.Triggers>
                                                                                        <MultiDataTrigger>
                                                                                                <MultiDataTrigger.Conditions>
                                                                                                        <Condition Binding="{Binding IsPartnerVerified}"
                                                                                                                   Value="False"/>
                                                                                                        <Condition Binding="{Binding HasPendingOutgoing}"
                                                                                                                   Value="False"/>
                                                                                                </MultiDataTrigger.Conditions>
                                                                                                <Setter Property="Visibility"
                                                                                                        Value="Visible"/>
                                                                                        </MultiDataTrigger>
                                                                                </Style.Triggers>
                                                                        </Style>
                                                                </Grid.Style>

                                                                <TextBlock Grid.Column="0"
                                                                           Text="Enter Partner Code:"
                                                                           VerticalAlignment="Center"/>
                                                                <TextBox Grid.Column="1"
                                                                         Width="200"
                                                                         Text="{Binding EnteredPartnerCode, UpdateSourceTrigger=PropertyChanged}"
                                                                         Margin="5,0"
                                                                         VerticalAlignment="Center"/>
                                                                <Button Grid.Column="2"
                                                                        Content="Send Request"
                                                                        Command="{Binding SendPartnerRequestCommand}"
                                                                        Margin="5,0"
                                                                        VerticalAlignment="Center"/>
                                                        </Grid>

                                                        <!-- STATE B: Waiting message -->
                                                        <Border x:Name="WaitingRow"
                                                                CornerRadius="6"
                                                                Padding="8"
                                                                Margin="0,0,0,0"
                                                                Background="{DynamicResource CardBackgroundBrush}"
                                                                BorderBrush="{DynamicResource CardBorderBrush}"
                                                                BorderThickness="1">
                                                                <!-- show when NOT connected AND HAS pending outgoing -->
                                                                <Border.Style>
                                                                        <Style TargetType="Border">
                                                                                <Setter Property="Visibility"
                                                                                        Value="Collapsed"/>
                                                                                <Style.Triggers>
                                                                                        <MultiDataTrigger>
                                                                                                <MultiDataTrigger.Conditions>
                                                                                                        <Condition Binding="{Binding IsPartnerVerified}"
                                                                                                                   Value="False"/>
                                                                                                        <Condition Binding="{Binding HasPendingOutgoing}"
                                                                                                                   Value="True"/>
                                                                                                </MultiDataTrigger.Conditions>
                                                                                                <Setter Property="Visibility"
                                                                                                        Value="Visible"/>
                                                                                        </MultiDataTrigger>
                                                                                </Style.Triggers>
                                                                        </Style>
                                                                </Border.Style>

                                                                <StackPanel Orientation="Horizontal"
                                                                            VerticalAlignment="Center">
                                                                        <ItemsControl ItemsSource="{Binding OutgoingPartnerRequests}">
                                                                                <ItemsControl.ItemTemplate>
                                                                                        <DataTemplate>
                                                                                                <Grid>
                                                                                                        <Grid.ColumnDefinitions>
                                                                                                                <ColumnDefinition Width="*"/>
                                                                                                                <ColumnDefinition Width="Auto"/>
                                                                                                        </Grid.ColumnDefinitions>

                                                                                                        <!-- Only show 'pending' rows -->
                                                                                                        <Grid.Style>
                                                                                                                <Style TargetType="Grid">
                                                                                                                        <Setter Property="Visibility"
                                                                                                                                Value="Collapsed"/>
                                                                                                                        <Style.Triggers>
                                                                                                                                <DataTrigger Binding="{Binding Status}"
                                                                                                                                             Value="pending">
                                                                                                                                        <Setter Property="Visibility"
                                                                                                                                                Value="Visible"/>
                                                                                                                                </DataTrigger>
                                                                                                                        </Style.Triggers>
                                                                                                                </Style>
                                                                                                        </Grid.Style>

                                                                                                        <TextBlock Grid.Column="0"
                                                                                                                   VerticalAlignment="Center"
                                                                                                                   Text="{Binding ToUserId, StringFormat=Waiting for {0} to accept…}"/>
                                                                                                        <Button Grid.Column="1"
                                                                                                                Content="Cancel Request"
                                                                                                                Margin="8,0,0,0"
                                                                                                                Command="{Binding DataContext.CancelPartnerRequestCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                                                CommandParameter="{Binding}"/>
                                                                                                </Grid>
                                                                                        </DataTemplate>
                                                                                </ItemsControl.ItemTemplate>
                                                                        </ItemsControl>
                                                                </StackPanel>
                                                        </Border>

                                                        <!-- STATE C: Connected summary -->
                                                        <StackPanel x:Name="ConnectedRow"
                                                                    Orientation="Horizontal">
                                                                <StackPanel.Style>
                                                                        <Style TargetType="StackPanel">
                                                                                <Setter Property="Visibility"
                                                                                                Value="Collapsed"/>
                                                                                <Style.Triggers>
                                                                                        <DataTrigger Binding="{Binding IsPartnerVerified}"
                                                                                                        Value="True">
                                                                                                <Setter Property="Visibility"
                                                                                                                Value="Visible"/>
                                                                                        </DataTrigger>
                                                                                </Style.Triggers>
                                                                        </Style>
                                                                </StackPanel.Style>

                                                                <TextBlock Text="{Binding ConnectionSummary}"
                                                                           FontWeight="Bold"
                                                                           FontSize="16"
                                                                           VerticalAlignment="Center"
                                                                           Margin="0,0,8,0"/>

                                                                <!-- New: Disconnect button -->
                                                                <Button Content="Disconnect"
                                                                        FontSize="16"
                                                                        Command="{Binding DisconnectPartnerCommand}"
                                                                        VerticalAlignment="Center"/>
                                                        </StackPanel>
                                                </Grid>
                                        </Grid>

                                        <!-- Requests Row -->
                                        <Grid>
                                                <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <GroupBox Grid.Column="0"
                                                          Header="Incoming Requests"
                                                          Margin="0,0,5,0">
                                                        <ItemsControl ItemsSource="{Binding IncomingPartnerRequests}">
                                                                <ItemsControl.ItemTemplate>
                                                                        <DataTemplate>
                                                                                <StackPanel Orientation="Horizontal"
                                                                                            Margin="5">
                                                                                        <TextBlock Text="{Binding FromDisplayName}"
                                                                                                   FontWeight="Bold"
                                                                                                   Margin="0,0,10,0"/>
                                                                                        <Button Content="Accept"
                                                                                                Command="{Binding DataContext.AcceptPartnerInviteCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                                CommandParameter="{Binding}"/>
                                                                                        <Button Content="Decline"
                                                                                                Command="{Binding DataContext.DeclinePartnerInviteCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                                CommandParameter="{Binding}"
                                                                                                Margin="5,0,0,0"/>
                                                                                </StackPanel>
                                                                        </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                </GroupBox>

                                                <GroupBox Grid.Column="1"
                                                          Header="Outgoing Requests"
                                                          Margin="5,0,0,0">
                                                        <ItemsControl ItemsSource="{Binding OutgoingPartnerRequests}">
                                                                <ItemsControl.ItemTemplate>
                                                                        <DataTemplate>
                                                                                <StackPanel Orientation="Horizontal"
                                                                                            Margin="5">
                                                                                        <TextBlock Text="{Binding ToUserId}"
                                                                                                   FontWeight="Bold"
                                                                                                   Margin="0,0,10,0"/>
                                                                                        <TextBlock Text="{Binding Status}"
                                                                                                   Margin="0,0,10,0"/>
                                                                                        <Button Content="Cancel"
                                                                                                Command="{Binding DataContext.CancelPartnerRequestCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                                CommandParameter="{Binding}"/>
                                                                                </StackPanel>
                                                                        </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                </GroupBox>
                                        </Grid>
                                </StackPanel>
                        </Expander>

                        <!-- TASK BUILDER -->
                        <Expander Style="{StaticResource CardExpander}">
                                <Expander.Header>
                                        <Grid>
                                                <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="Task Builder"
                                                           Style="{StaticResource SectionHeader}"
                                                           Margin="0"/>
                                                <TextBlock Grid.Column="1"
                                                           Text="▼"
                                                           Opacity="0.6"
                                                           Margin="8,0,0,0"/>
                                        </Grid>
                                </Expander.Header>

                                <!-- Content when expanded (your existing Task Builder content WITHOUT the title) -->
                                <StackPanel Orientation="Horizontal"
                                            VerticalAlignment="Center">
                                        <StackPanel>
                                                <TextBlock Text="Title"
                                                           Margin="5,0,5,0"/>
                                                <TextBox Width="180"
                                                         Text="{Binding NewTaskTitle}"/>
                                        </StackPanel>
                                        <StackPanel>
                                                <TextBlock Text="Description"
                                                           Margin="5,0,5,0"/>
                                                <TextBox Width="180"
                                                         Text="{Binding NewTaskDescription, UpdateSourceTrigger=PropertyChanged}"
                                                         ToolTip="Optional task description"/>
                                        </StackPanel>
                                        <StackPanel>
                                                <TextBlock Text="Category"
                                                           Margin="5,0,5,0"/>
                                                <ComboBox Width="120"
                                                          ItemsSource="{Binding Categories}"
                                                          SelectedItem="{Binding NewTaskCategory}"/>
                                        </StackPanel>
                                        <StackPanel>
                                                <TextBlock Text="Due Date"
                                                           Margin="5,0,5,0"/>
                                                <DatePicker Width="130"
                                                            SelectedDate="{Binding NewTaskDueDate}"/>
                                        </StackPanel>
                                        <StackPanel>
                                                <TextBlock Text="Assign To"
                                                           Margin="5,0,5,0"/>
                                                <ComboBox Width="120"
                                                          SelectedItem="{Binding NewTaskAssignee}">
                                                        <ComboBoxItem Content="Me"/>
                                                        <ComboBoxItem Content="Partner"/>
                                                </ComboBox>
                                        </StackPanel>
                                        <Button Content="Add Task"
                                                Width="100"
                                                Margin="10,15,0,0"
                                                Command="{Binding AddTaskCommand}"/>
                                </StackPanel>
                        </Expander>

                </StackPanel>



                <!-- TASK LISTS in a big card -->
                <Border Grid.Row="1"
                        Style="{StaticResource Card}">
                        <Grid>
                                <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <!-- Title row -->
                                        <RowDefinition Height="*"/>
                                        <!-- Lists -->
                                </Grid.RowDefinitions>
                                <!-- Section title -->
                                <TextBlock Grid.Row="0"
                                           Text="Task Board"
                                           Style="{StaticResource SectionHeader}"/>

                                <Grid Grid.Row="1">
                                        <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>


                                        <!-- MY TASKS (left sub-card) -->
                                        <Border Grid.Column="0"
                                                Style="{StaticResource SubCard}"
                                                Background="{DynamicResource SubCardLeftBrush}">
                                                <Grid>
                                                        <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="*"/>
                                                        </Grid.RowDefinitions>

                                                        <TextBlock Grid.Row="0"
                                                                   Text="My Tasks"
                                                                   Style="{StaticResource SectionHeader}"/>

                                                        <!-- Column headers (optional—keep your current look) -->
                                                        <Grid Grid.Row="1"
                                                              Background="{DynamicResource HeaderRowBackgroundBrush}"
                                                              Margin="0,0,0,6">
                                                                <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="30"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="140"/>
                                                                        <ColumnDefinition Width="140"/>
                                                                        <ColumnDefinition Width="40"/>
                                                                </Grid.ColumnDefinitions>
                                                                <TextBlock Text="✓"
                                                                           Grid.Column="0"
                                                                           FontWeight="Bold"/>
                                                                <TextBlock Text="Task"
                                                                           Grid.Column="1"
                                                                           FontWeight="Bold"/>
                                                                <TextBlock Text="Category"
                                                                           Grid.Column="2"
                                                                           FontWeight="Bold"/>
                                                                <TextBlock Text="Due"
                                                                           Grid.Column="3"
                                                                           FontWeight="Bold"/>
                                                                <TextBlock Text="❌"
                                                                           Grid.Column="4"
                                                                           FontWeight="Bold"
                                                                           HorizontalAlignment="Center"/>
                                                        </Grid>

                                                        <!-- Items as mini-cards -->
                                                        <ScrollViewer Grid.Row="2"
                                                                      VerticalScrollBarVisibility="Auto">
                                                                <ItemsControl ItemsSource="{Binding MyTasksView}">
                                                                        <ItemsControl.Resources>
                                                                                <Style TargetType="TextBlock"
                                                                                       BasedOn="{StaticResource {x:Type TextBlock}}">
                                                                                        <Setter Property="Foreground"
                                                                                                Value="{DynamicResource PrimaryTextBrush}"/>
                                                                                </Style>
                                                                        </ItemsControl.Resources>
                                                                        <ItemsControl.ItemsPanel>
                                                                                <ItemsPanelTemplate>
                                                                                        <StackPanel/>
                                                                                </ItemsPanelTemplate>
                                                                        </ItemsControl.ItemsPanel>
                                                                        <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                        <Border Style="{StaticResource TaskItemCard}"
                                                                                                ToolTip="{Binding Description}">
                                                                                                <Grid>
                                                                                                        <Grid.ColumnDefinitions>
                                                                                                                <ColumnDefinition Width="30"/>
                                                                                                                <ColumnDefinition Width="*"/>
                                                                                                                <ColumnDefinition Width="140"/>
                                                                                                                <ColumnDefinition Width="140"/>
                                                                                                                <ColumnDefinition Width="40"/>
                                                                                                        </Grid.ColumnDefinitions>

                                                                                                        <CheckBox IsChecked="{Binding IsCompleted}"
                                                                                                                  Margin="2"
                                                                                                                  Checked="CheckBox_Changed"
                                                                                                                  Unchecked="CheckBox_Changed"/>

                                                                                                        <TextBlock Grid.Column="1"
                                                                                                                   Style="{StaticResource TaskRowTextStyle}"
                                                                                                                   Text="{Binding Title}"
                                                                                                                   TextDecorations="{Binding IsCompleted, Converter={StaticResource BoolToTextDecorationsConverter}}"
                                                                                                                   VerticalAlignment="Center">

                                                                                                        </TextBlock>

                                                                                                        <TextBlock Grid.Column="2"
                                                                                                                   Style="{StaticResource TaskRowTextStyle}"
                                                                                                                   Text="{Binding Category}"
                                                                                                                   VerticalAlignment="Center"/>
                                                                                                        <TextBlock Grid.Column="3"
                                                                                                                   Style="{StaticResource TaskRowTextStyle}"
                                                                                                                   Text="{Binding DueDate, StringFormat=d}"
                                                                                                                   VerticalAlignment="Center"/>

                                                                                                        <Button Grid.Column="4"
                                                                                                                Content="✕"
                                                                                                                Width="30"
                                                                                                                Height="25"
                                                                                                                Command="{Binding DataContext.DeleteTaskCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                                                CommandParameter="{Binding}"/>
                                                                                                </Grid>
                                                                                        </Border>
                                                                                </DataTemplate>
                                                                        </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                        </ScrollViewer>
                                                </Grid>
                                        </Border>

                                        <!-- PARTNER TASKS (right sub-card) -->
                                        <Border Grid.Column="1"
                                                Style="{StaticResource SubCard}"
                                                Background="{DynamicResource SubCardRightBrush}"
                                                Visibility="{Binding ShowPartnerList, Converter={StaticResource BoolToVisibility}}">
                                                <Grid>
                                                        <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="*"/>
                                                        </Grid.RowDefinitions>

                                                        <TextBlock Grid.Row="0"
                                                                   Text="Partner's Tasks"
                                                                   Style="{StaticResource SectionHeader}"/>

                                                        <Grid Grid.Row="1"
                                                              Background="{DynamicResource HeaderRowBackgroundBrush}"
                                                              Margin="0,0,0,6">
                                                                <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="30"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="140"/>
                                                                        <ColumnDefinition Width="140"/>
                                                                        <ColumnDefinition Width="40"/>
                                                                </Grid.ColumnDefinitions>
                                                                <TextBlock Text="✓"
                                                                           Grid.Column="0"
                                                                           FontWeight="Bold"/>
                                                                <TextBlock Text="Task"
                                                                           Grid.Column="1"
                                                                           FontWeight="Bold"/>
                                                                <TextBlock Text="Category"
                                                                           Grid.Column="2"
                                                                           FontWeight="Bold"/>
                                                                <TextBlock Text="Due"
                                                                           Grid.Column="3"
                                                                           FontWeight="Bold"/>
                                                                <TextBlock Text="❌"
                                                                           Grid.Column="4"
                                                                           FontWeight="Bold"
                                                                           HorizontalAlignment="Center"/>
                                                        </Grid>

                                                        <ScrollViewer Grid.Row="2"
                                                                      VerticalScrollBarVisibility="Auto">
                                                                <ItemsControl ItemsSource="{Binding PartnerTasksView}">
                                                                        <ItemsControl.Resources>
                                                                                <Style TargetType="TextBlock"
                                                                                       BasedOn="{StaticResource {x:Type TextBlock}}">
                                                                                        <Setter Property="Foreground"
                                                                                                Value="{DynamicResource PrimaryTextBrush}"/>
                                                                                </Style>
                                                                        </ItemsControl.Resources>
                                                                        <ItemsControl.ItemsPanel>
                                                                                <ItemsPanelTemplate>
                                                                                        <StackPanel/>
                                                                                </ItemsPanelTemplate>
                                                                        </ItemsControl.ItemsPanel>
                                                                        <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                        <Border Style="{StaticResource TaskItemCard}"
                                                                                                ToolTip="{Binding Description}"
                                                                                                Visibility="{Binding AssignedTo, Converter={StaticResource AssigneeToVisibilityConverter}, ConverterParameter=Partner}">
                                                                                                <Grid>
                                                                                                        <Grid.ColumnDefinitions>
                                                                                                                <ColumnDefinition Width="30"/>
                                                                                                                <ColumnDefinition Width="*"/>
                                                                                                                <ColumnDefinition Width="140"/>
                                                                                                                <ColumnDefinition Width="140"/>
                                                                                                                <ColumnDefinition Width="40"/>
                                                                                                        </Grid.ColumnDefinitions>

                                                                                                        <CheckBox IsChecked="{Binding IsCompleted}"
                                                                                                                  Margin="2"
                                                                                                                  Checked="CheckBox_Changed"
                                                                                                                  Unchecked="CheckBox_Changed"/>

                                                                                                        <TextBlock Grid.Column="1"
                                                                                                                   Style="{StaticResource TaskRowTextStyle}"
                                                                                                                   Text="{Binding Title}"
                                                                                                                   TextDecorations="{Binding IsCompleted, Converter={StaticResource BoolToTextDecorationsConverter}}"
                                                                                                                   VerticalAlignment="Center">

                                                                                                        </TextBlock>

                                                                                                        <TextBlock Grid.Column="2"
                                                                                                                   Style="{StaticResource TaskRowTextStyle}"
                                                                                                                   Text="{Binding Category}"
                                                                                                                   VerticalAlignment="Center"/>
                                                                                                        <TextBlock Grid.Column="3"
                                                                                                                   Style="{StaticResource TaskRowTextStyle}"
                                                                                                                   Text="{Binding DueDate, StringFormat=d}"
                                                                                                                   VerticalAlignment="Center"/>

                                                                                                        <Button Grid.Column="4"
                                                                                                                Content="✕"
                                                                                                                Width="30"
                                                                                                                Height="25"
                                                                                                                Command="{Binding DataContext.DeleteTaskCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                                                CommandParameter="{Binding}"/>
                                                                                                </Grid>
                                                                                        </Border>
                                                                                </DataTemplate>
                                                                        </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                        </ScrollViewer>
                                                </Grid>
                                        </Border>
                                </Grid>
                        </Grid>
                </Border>
                <StackPanel Grid.Row="2"
                            Margin="5"
                            Background="#FFFDE7">
                        <TextBlock Text="Pending Partner Tasks"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   Margin="5"/>
                        <ItemsControl ItemsSource="{Binding PendingTasks}">
                                <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                                <Border BorderBrush="#E0E0E0"
                                                        BorderThickness="1"
                                                        CornerRadius="5"
                                                        Margin="5"
                                                        Padding="5"
                                                        Background="White">
                                                        <StackPanel Orientation="Horizontal"
                                                                    VerticalAlignment="Center">
                                                                <TextBlock Text="{Binding Title}"
                                                                           Margin="5"
                                                                           VerticalAlignment="Center"/>
                                                                <TextBlock Text="{Binding Category}"
                                                                           Margin="5"
                                                                           VerticalAlignment="Center"/>
                                                                <Button Content="Accept"
                                                                        Command="{Binding DataContext.AcceptTaskCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                        CommandParameter="{Binding}"
                                                                        Margin="5"/>
                                                                <Button Content="Decline"
                                                                        Command="{Binding DataContext.DeclineTaskCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                        CommandParameter="{Binding}"
                                                                        Margin="5"/>
                                                        </StackPanel>
                                                </Border>
                                        </DataTemplate>
                                </ItemsControl.ItemTemplate>
                        </ItemsControl>
                </StackPanel>

                <!-- First-run Welcome Overlay -->
                <Grid Visibility="{Binding NeedsProfileSetup, Converter={StaticResource BoolToVisibility}}">
                        <Rectangle Fill="#80000000"/>
                        <Border Background="{DynamicResource OverlayPanelBrush}"
                                Padding="24"
                                CornerRadius="10"
                                Width="400"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center">
                                <StackPanel>
                                        <TextBlock Text="Welcome to To-Duo"
                                                   FontSize="20"
                                                   FontWeight="Bold"
                                                   Margin="0,0,0,10"/>
                                        <TextBlock Text="Enter your name:"
                                                   Margin="0,0,0,8"/>
                                        <TextBox Text="{Binding NewDisplayName, UpdateSourceTrigger=PropertyChanged}"/>
                                        <Button Content="Continue"
                                                Command="{Binding SaveDisplayNameCommand}"
                                                Margin="0,10,0,0"/>
                                </StackPanel>
                        </Border>
                </Grid>



        </Grid>
</Window>
        